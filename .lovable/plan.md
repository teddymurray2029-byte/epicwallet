

# Fix: Stripe Ephemeral Key Nonce Version Mismatch

## Problem
The "No such ephemeralkeynonce" error occurs because of an API version mismatch between the frontend and backend:
- **Frontend**: `@stripe/stripe-js` v8.x loads **Stripe.js clover** (API family `clover`)
- **Backend**: The edge function creates ephemeral keys with `Stripe-Version: 2025-08-27.basil`

A nonce generated by clover Stripe.js cannot be used with a basil API version -- they are incompatible release families.

## Fix
Update the `Stripe-Version` header in `supabase/functions/virtual-card/index.ts` from `2025-08-27.basil` to `2025-09-30.clover` (the first clover release, matching the frontend SDK family).

### Change (single line)

**File:** `supabase/functions/virtual-card/index.ts` (~line 227)

```text
Before: }, { 'Stripe-Version': '2025-08-27.basil' });
After:  }, { 'Stripe-Version': '2025-09-30.clover' });
```

## Why This Works
Each Stripe.js major version is pinned to a release family. v8 = clover. The ephemeral key nonce is scoped to the same family, so the backend must request the ephemeral key using a clover API version for the nonce to be recognized.

No other files need to change.

